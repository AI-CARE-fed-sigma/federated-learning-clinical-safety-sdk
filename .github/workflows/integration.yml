name: SDK ↔ Server Integration

on: [push, pull_request]

jobs:
  integration:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout SDK
        uses: actions/checkout@v4

      - name: Checkout Server
        uses: actions/checkout@v4
        with:
          repository: AlexDobsonPleming/federated-learning-clinical-safety-server
          path: server

      - name: Install Docker Compose
        run: sudo apt-get update && sudo apt-get install -y docker-compose

      - name: Build & start server (with seed & uploader)
        working-directory: server
        run: docker compose -f docker-compose.test.yml up --build -d

      - name: Wait for API to bind port 8000
        working-directory: server
        run: |
          for i in $(seq 1 20); do
            if ss -ltn | grep -q ':8000'; then
              echo "✅ port 8000 is listening"
              exit 0
            fi
            echo "⏳ waiting for port 8000..."
            sleep 2
          done
          echo "❌ port 8000 never bound"
          docker compose -f docker-compose.test.yml logs api
          exit 1

      - name: Verify "api" container is Up
        working-directory: server
        run: |
          if ! docker compose -f docker-compose.test.yml ps api | grep -qw Up; then
            echo "❌ api container failed to stay Up"
            docker compose -f docker-compose.test.yml logs api
            exit 1
          fi
          echo "✅ api container is Up"

      - name: Extract SDK_TEST_TOKEN
        working-directory: server
        run: |
          echo "=== RAW API LOGS START ==="
          # Grab all the logs, then find the first "Token:" line anywhere and strip up to the colon
          docker compose -f docker-compose.test.yml logs api
          echo "=== RAW API LOGS END ==="

          # Now capture them into a variable
          RAW=$(docker compose -f docker-compose.test.yml logs api)
          TOKEN=$(echo "$RAW" \
                    | grep 'Token:' \
                    | head -n1 \
                    | sed -E 's/.*Token:[[:space:]]*//')
          if [ -z "$TOKEN" ]; then
            echo "❌ Could not find 'Token:' in logs"
            exit 1
          fi
          echo "✅ Extracted token: $TOKEN"
          echo "SDK_TEST_TOKEN=$TOKEN" >> $GITHUB_ENV


      - name: Setup Python & Poetry
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Poetry
        run: pip install poetry

      - name: Install SDK dependencies
        run: |
          poetry config virtualenvs.in-project true
          poetry install --no-interaction --no-ansi

      - name: Run integration tests
        env:
          API_BASE_URL: http://localhost:8000/api
          SDK_TEST_TOKEN: ${{ env.SDK_TEST_TOKEN }}
        run: poetry run pytest src/tests/test_integration.py

      - name: Tear down
        if: always()
        working-directory: server
        run: docker compose -f docker-compose.test.yml down --volumes --remove-orphans
