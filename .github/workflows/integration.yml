name: SDK â†” Server Integration

on: [push, pull_request]

jobs:
  integration:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout SDK
        uses: actions/checkout@v4

      - name: Checkout Server
        uses: actions/checkout@v4
        with:
          repository: AlexDobsonPleming/federated-learning-clinical-safety-server
          path: server

      - name: Install Docker Compose
        run: sudo apt-get update && sudo apt-get install -y docker-compose dos2unix

      - name: Build server image without cache
        working-directory: server
        run: docker compose -f docker-compose.test.yml build --no-cache

      - name: Bring up server (fresh build)
        working-directory: server
        run: docker compose -f docker-compose.test.yml up --force-recreate -d

      - name: Dump entrypoint script & full logs
        working-directory: server
        run: |
          CID=$(docker ps -aq -f "name=^api_test$")
          echo "ðŸ” /app/docker-entrypoint.sh contents:"
          docker exec $CID cat /app/docker-entrypoint.sh || true
          echo
          echo "ðŸ” Full timestamped logs:"
          docker logs --timestamps $CID || true

      - name: Check container exit code & tail logs
        working-directory: server
        run: |
          CID=$(docker ps -aq -f "name=^api_test$")
          echo "ðŸ“¦ api_test ExitCode & Status:"
          docker inspect --format='ExitCode={{.State.ExitCode}} Status={{.State.Status}}' $CID
          echo
          echo "ðŸ” Last 50 lines of raw logs:"
          docker logs --tail 50 $CID || true

      - name: Wait for API to bind port 8000
        working-directory: server
        run: |
          for i in $(seq 1 20); do
            if ss -ltn | grep -q ':8000'; then
              echo "âœ… port 8000 is listening"
              exit 0
            fi
            echo "â³ waiting for port 8000..."
            sleep 2
          done
          echo "âŒ port 8000 never bound"
          docker compose -f docker-compose.test.yml logs api
          exit 1

      - name: Verify "api_test" container is up
        working-directory: server
        run: |
          CID=$(docker ps -aq -f "name=^api_test$")
          if [ -z "$CID" ]; then
            echo "âŒ Could not find a container named api_test"
            docker ps -a
            exit 1
          fi
          if ! docker inspect --format='{{.State.Running}}' $CID | grep -q true; then
            echo "âŒ api_test container is not running"
            echo "â†’ State: $(docker inspect --format='{{.State.Status}}' $CID)'"
            echo "----- logs -----"
            docker logs $CID || true
            exit 1
          fi
          echo "âœ… api_test container ($CID) is running"

      - name: Debug token creation in container logs
        working-directory: server
        run: |
          CID=$(docker ps -aq -f "name=^api_test$")
          echo "ðŸ” Container logs for api_test ($CID):"
          docker logs $CID || true
          echo
          echo "ðŸ” Looking for the write confirmation:"
          if docker logs $CID 2>&1 | grep -q 'Wrote token to'; then
            echo "âœ… Found the write confirmation."
          else
            echo "âŒ No 'Wrote token to' message."
          fi

      - name: Extract SDK_TEST_TOKEN from file
        working-directory: server
        run: |
          CID=$(docker ps -aq -f "name=^api_test$")
          echo "ðŸ“¦ Using container $CID"
          echo "Contents of /tmp in api_test:"
          docker exec $CID ls -la /tmp || true
          docker cp $CID:/tmp/uploader_token.txt uploader_token.txt
          TOKEN=$(cat uploader_token.txt)
          echo "âœ… Got SDK_TEST_TOKEN=$TOKEN"
          echo "SDK_TEST_TOKEN=$TOKEN" >> $GITHUB_ENV

      - name: Setup Python & Poetry
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Poetry
        run: pip install poetry

      - name: Install SDK dependencies
        run: |
          poetry config virtualenvs.in-project true
          poetry install --no-interaction --no-ansi

      - name: Run integration tests
        env:
          API_BASE_URL: http://localhost:8000/api
          SDK_TEST_TOKEN: ${{ env.SDK_TEST_TOKEN }}
        run: poetry run pytest src/tests/test_integration.py

      - name: Tear down
        if: always()
        working-directory: server
        run: docker compose -f docker-compose.test.yml down --volumes --remove-orphans
